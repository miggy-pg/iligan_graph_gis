{% extends 'base.html' %}
{% load static %}
{% load leaflet_tags l10n %}
{% load crispy_forms_tags %}
{% block content %}
    <div class="container">
        {{ route|json_script:"route" }}

        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
        <!-- banner section start -->
        <div class="banner_section">
            <div class="container">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="banner_taital">
                            <div class="about_taital">Search:</div>
                            <div class="marker-card position-absolute" id="marker_card">
                                <div class="row justify-content-center">
                                    <div class="w-25 py-5">
                                        <div class="text-center" id="marker_card_content">
                                        </div>
                                    </div>
                                </div>
                            </div>  
                            {{ jsonMarkers|json_script:"jsonMarkers" }}

                            <form method="POST">
                                {% csrf_token %}
                                {{ form }}
                                <button type="submit" class="btn btn-primary mb-3 ">Search</button>
                            </form>
                            {% leaflet_map "leaflet" callback="window.leafletMarkers" %}
                        </div>
                    </div>  
                </div>
            </div>
        </div>
        <!-- banner section end -->

        <div class="direction_container">
            <div class="row">
                <div class="col-4">
                    <div class="direction">
                        <h2>Directions: </h2>
                        <ul class="horizontal-list">
                            <li style="background-color: white; color: white;" id="possible_paths">
                        </ul>
                    </div>
                </div>
                <div class="col">
                    <div class="establishments">
                        <h2>Establishments: </h2>
                        <ul class="horizontal-list">
                            <li style="background-color: white; color: white;" id="route_establishments">
                        </ul>
                    </div>
                </div>  
            </div>    
        </div> 
    </div>

    <!-- about section start -->
    <div class="about_section">
        <div class="container mb-5">
            <div class="row">
                <div class="col">
                    <div class="bg-white p-4 py-3">
                            <form method="POST" enctype="multipart/form-data">
                                {% csrf_token %}
                                <label for="my_file">You can upload multiple locations in a single file.</label>
                                <br>
                                <input type="file" name="my_file" />
                                <br>
                                <br>
                                <button type="submit" class="btn btn-secondary">Upload</button>
                            </form>
                            <br>
                            <br>
                            <form class="form-control" action="modifymarker/" method="POST" onSubmit="return ValidateMarkerSubmittion()"> {% csrf_token %}
                                <input type="hidden" name="modifyType" value="add">
                                {% csrf_token %}
                                <label>You also have the option to manually assign the markers.</label>
                                {{ upload_form|crispy }}
                                <div class="button mt-3 text-left">
                                    <button class="btn btn-dark mb-4">Set Marker</button>
                                </div>
                            </form>
                   </div>
                </div>
                <div class="col">
                    <div class="p-4 bg-white">
                    <h5>Remove Marker</h5>
                        <form action="modifymarker/" method="POST" onSubmit="return ValidateMarkerSubmittion()"> 
                            {% csrf_token %}
                            <div class="form-floating mb-2">
                                <input type="text" class="form-control" name="name" id="marker_name" placeholder="Marker Name" required>
                            </div>
                            <input type="hidden" name="modifyType" value="remove">
                            <div class="button mt-4 text-left">
                                <button class="btn btn-dark">Remove Marker</button>
                            </div>
                        </form>
                    </div>
               </div>
           </div>
        </div>
     </div>
     <!-- about section end -->
    <script type="text/javascript" src="{% static 'leaflet/Control.Geocoder.js' %}"></script>
    <script type="text/javascript" src="{% static 'leaflet/leaflet.ajax.js' %}"></script>
    <script type="text/javascript" src="{% static 'leaflet/leaflet.ajax.min.js' %}"></script>
    <script>
        function leafletMarkers(map, options){
            var directions = []
            var establishments = []
            
            // Map the edge of the graph
            const jsonMarkers = JSON.parse(document.getElementById('jsonMarkers').textContent); 
            const possible_paths = document.getElementById('possible_paths')  
            const route_establishments = document.getElementById('route_establishments')  
            
            let objectjsonMarkers = eval('(' + jsonMarkers + ')');
            const arr_test = objectjsonMarkers.map(route => {directions.push(route)})
            // Iterate over each array in the directions variable
            for (var i = 0; i < directions.length; i++) {
                
                var button_list = document.createElement("li"); // Create a button
                button_list.textContent = `Route ${i+1}`; // Button text
                button_list.setAttribute('id', `${i}`);
                button_list.style.cursor = 'pointer';
                
                var establishment_container = document.createElement('div');
                const unique_estab = directions[i][1].map(marker => marker.name)
                establishment_container.textContent = `${[...new Set(unique_estab)]}`
                establishment_container.style.color = "black";
                establishment_container.style.width = '600px';
                establishment_container.style.textAlign = 'left';
                establishment_container.setAttribute('id', `${i}`);
                establishment_container.style.display = "none";
            
                possible_paths.appendChild(button_list); // Append the div to the body or your desired container
                route_establishments.appendChild(establishment_container); // Append the div to the body or your desired container
            }
            var buttons = possible_paths.getElementsByTagName('li');
            var divs = route_establishments.getElementsByTagName('div');
            console.log(buttons.length);
            var polylineLayer = null;
            var markersLayer = null
            var currEstabBlock = null
            for (var i = 0; i < buttons.length; i++) {

                buttons[i].addEventListener('click', function(ev) {
                    var markers = L.layerGroup().addTo(map);

                    if (polylineLayer) {
                        map.removeLayer(polylineLayer);
                        map.removeLayer(markersLayer)
                        currEstabBlock.style.display = "none"
                    }
                    
                    var curr_estab = divs[ev.target.id]
                    curr_estab.style.display = "block"
                    // Establishments
                    directions[ev.target.id][1].forEach(marker => {
                        var latlngs = L.marker([marker["lat"], marker["lng"]]).addTo(markers)
                        latlngs.bindPopup(marker["category_level"].toString()).openPopup(); 
                    })

                    // Routes
                    // Create a new polyline layer using the provided coordinates
                    var polyline = L.polyline(directions[ev.target.id][0]).addTo(map);
                    
                    // Update the currently displayed polyline layer
                    polylineLayer = polyline;
                    markersLayer = markers
                    currEstabBlock = curr_estab
                });
            }
        }
    </script>
</div>
{% endblock %}
